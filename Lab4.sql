set SERVEROUTPUT ON;
set timing on;

CREATE TABLE DIAGNOSTICS_LOG (
    LOG_ID      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SUBJ_ID     NUMBER,
    OLD_SUBJ_ID NUMBER,
    NEW_SUBJ_ID NUMBER,
    MESSAGE     VARCHAR2(255),
    LOG_DATE    TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE OR REPLACE TRIGGER trg_check_subject_id
BEFORE UPDATE OF SUBJ_ID ON SUBJECT
FOR EACH ROW
DECLARE
    v_threshold NUMBER := 100;
    v_message   VARCHAR2(255);
BEGIN
    IF ABS(:NEW.SUBJ_ID - :OLD.SUBJ_ID) > v_threshold THEN
        v_message := 'SUBJ_ID change exceeds threshold: old value = ' || :OLD.SUBJ_ID || ', new value = ' || :NEW.SUBJ_ID;
        
        INSERT INTO DIAGNOSTICS_LOG (SUBJ_ID, OLD_SUBJ_ID, NEW_SUBJ_ID, MESSAGE)
        VALUES (:NEW.SUBJ_ID, :OLD.SUBJ_ID, :NEW.SUBJ_ID, v_message);

        DBMS_OUTPUT.PUT_LINE(v_message);
    END IF;
END;

UPDATE SUBJECT SET SUBJ_ID = 301 WHERE SUBJ_ID = 101;
UPDATE SUBJECT SET SUBJ_ID = 103 WHERE SUBJ_ID = 71;